{% extends "base.html" %}

{% block title %}Products - Best Buy Finder{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header & Search -->
    <div class="row mb-5 align-items-center animate-fade-in">
        <div class="col-lg-6">
            <h1 class="fw-bold mb-0">Discover Products</h1>
            <p class="text-muted mt-2">Find the best deals from top retailers</p>
        </div>
        <div class="col-lg-6">
            <div class="input-group shadow-sm rounded-pill overflow-hidden">
                <input type="text" id="searchInput" class="form-control border-0 py-3 ps-4" placeholder="Search products..." oninput="filterLocal()">
                <button class="btn btn-primary px-4" type="button" onclick="performOnlineSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="d-flex gap-2 mb-4 overflow-auto pb-2 animate-fade-in delay-100">
        <button class="btn btn-dark rounded-pill px-4 active" onclick="filterSource('all')">All</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('macys')">Macy's</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('nordstrom')">Nordstrom</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('sephora')">Sephora (Beauty)</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('barnesandnoble')">Barnes & Noble (Books)</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('dicks')">Dick's Sporting Goods</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('homedepot')">Home Depot</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('chewy')">Chewy (Pets)</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('guitarcenter')">Guitar Center</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('staples')">Staples (Office)</button>
    </div>

    <!-- Lowest Price Card Section (Hidden by default) -->
    <div id="lowestPriceSection" class="mb-5 d-none animate-fade-in">
        <div class="card border-0 shadow-sm bg-primary text-white overflow-hidden">
            <div class="card-body p-4 position-relative">
                <div class="position-absolute top-0 end-0 m-3 opacity-25">
                    <i class="fas fa-tag fa-5x"></i>
                </div>
                <h6 class="text-uppercase fw-bold opacity-75 mb-2">ðŸ”¥ Best Deal Found</h6>
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h2 class="fw-bold mb-1" id="lp-name">Product Name</h2>
                        <div class="d-flex align-items-center gap-3">
                            <h3 class="fw-bold mb-0">â‚¹<span id="lp-price">0</span></h3>
                            <span class="badge bg-white text-primary" id="lp-source">Source</span>
                        </div>
                    </div>
                    <div class="ms-3">
                        <button class="btn btn-light rounded-pill px-4 fw-bold" id="lp-btn">
                            View Deal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div id="loadingDiv" class="text-center py-5">
        <div class="spinner-custom mx-auto mb-3"></div>
        <p class="text-muted">Loading amazing deals...</p>
    </div>

    <div id="productsGrid" class="row g-4">
        <!-- Products will be injected here -->
    </div>
</div>

<!-- Modals -->
<!-- Price History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Price History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Price Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Set Price Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alertForm" onsubmit="submitAlert(event)">
                    <input type="hidden" id="alertProductTitle">
                    <div class="mb-3">
                        <label class="form-label">Target Price (â‚¹)</label>
                        <input type="number" id="alertTargetPrice" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="alertEmail" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Set Alert</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AI Summary Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-robot me-2"></i>AI Summary</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="aiSummaryContent" class="p-3">
                    <div class="spinner-border text-info" role="status"></div> Generating summary...
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let allProducts = [];

    document.addEventListener('DOMContentLoaded', loadProducts);

    async function loadProducts() {
        const loadingDiv = document.getElementById('loadingDiv');
        const productsGrid = document.getElementById('productsGrid');

        try {
            const response = await fetch('/api/products', { credentials: 'include' });
            const data = await response.json();
            
            if (response.ok && data.products) {
                allProducts = data.products;
                loadingDiv.style.display = 'none';
                displayProducts(allProducts);
            } else {
                loadingDiv.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>Failed to load products</div>';
                showMessage('Failed to load products', 'error');
            }
        } catch (error) {
            loadingDiv.innerHTML = '<div class="text-danger"><i class="fas fa-wifi me-2"></i>Network error</div>';
            showMessage('Network error: ' + error.message, 'error');
        }
    }

    function displayProducts(products) {
        const grid = document.getElementById('productsGrid');
        const lpSection = document.getElementById('lowestPriceSection');
        grid.innerHTML = '';

        if (!products || products.length === 0) {
            lpSection.classList.add('d-none');
            grid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h3>No products found</h3>
                    <p class="text-muted">Try adjusting your search or filters</p>
                </div>
            `;
            return;
        }

        // Find lowest price product
        let minPrice = Infinity;
        let bestDeal = null;

        products.forEach(p => {
            const price = parseFloat(p.price) || 0;
            if (price > 0 && price < minPrice) {
                minPrice = price;
                bestDeal = p;
            }
        });

        // Update Lowest Price Card
        if (bestDeal) {
            lpSection.classList.remove('d-none');
            document.getElementById('lp-name').textContent = bestDeal.name || bestDeal.title || 'Unknown';
            document.getElementById('lp-price').textContent = bestDeal.price;
            document.getElementById('lp-source').textContent = bestDeal.source;
            
            const safeId = String(bestDeal.id).replace(/'/g, "\\'");
            document.getElementById('lp-btn').onclick = () => addToCart(safeId);
        } else {
            lpSection.classList.add('d-none');
        }

        products.forEach((product, index) => {
            const delayClass = index < 6 ? `delay-${(index + 1) * 100}` : '';
            const card = document.createElement('div');
            card.className = `col-sm-6 col-lg-4 col-xl-3 animate-slide-in-up ${delayClass}`;
            
            // Handle missing data gracefully
            const imgUrl = product.image || 'https://placehold.co/300x300?text=No+Image';
            const name = product.name || product.title || 'Unknown Product';
            const price = product.price !== undefined ? product.price : 'N/A';
            const source = product.source || 'Unknown';
            const productId = product.id || index; // Fallback ID
            const safeId = String(productId).replace(/'/g, "\\'");
            const safeName = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            card.innerHTML = `
                <div class="product-card h-100 d-flex flex-column">
                    <div class="product-img-wrapper position-relative">
                        <span class="badge bg-dark position-absolute top-0 start-0 m-3 text-uppercase">${source}</span>
                        <span class="badge bg-info position-absolute top-0 end-0 m-3 cursor-pointer" onclick="showAiSummary('${safeName}')" style="cursor: pointer;">
                            <i class="fas fa-robot"></i> AI
                        </span>
                        <img src="${imgUrl}" class="product-img" alt="${name}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/300x300?text=Image+Not+Found';">
                    </div>
                    <div class="card-body d-flex flex-column flex-grow-1">
                        <h5 class="card-title" title="${name}">${name}</h5>
                        
                        <div class="d-flex gap-2 mb-3">
                             <button class="btn btn-sm btn-light flex-fill" onclick="showPriceHistory('${safeName}', ${price})">
                                <i class="fas fa-chart-line"></i> History
                             </button>
                             <button class="btn btn-sm btn-light flex-fill" onclick="setAlert('${safeName}', ${price})">
                                <i class="fas fa-bell"></i> Alert
                             </button>
                        </div>

                        <div class="mt-auto pt-3 d-flex justify-content-between align-items-center">
                            <span class="price-tag">â‚¹${price}</span>
                            <button onclick="addToCart('${safeId}')" class="btn btn-outline-primary rounded-circle p-2" title="Add to Cart">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function showPriceHistory(title, price) {
        const modal = new bootstrap.Modal(document.getElementById('historyModal'));
        modal.show();
        
        fetch('/api/price-history', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title, price })
        })
        .then(res => res.json())
        .then(data => {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            // Destroy existing chart if any
            if (window.myChart) window.myChart.destroy();
            
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.history.map(h => h.date),
                    datasets: [{
                        label: 'Price History',
                        data: data.history.map(h => h.price),
                        borderColor: '#0d6efd',
                        tension: 0.1
                    }]
                }
            });
        });
    }

    function setAlert(title, price) {
        document.getElementById('alertProductTitle').value = title;
        document.getElementById('alertTargetPrice').value = Math.floor(price * 0.9); // Default to 10% off
        new bootstrap.Modal(document.getElementById('alertModal')).show();
    }

    async function submitAlert(e) {
        e.preventDefault();
        const title = document.getElementById('alertProductTitle').value;
        const target_price = document.getElementById('alertTargetPrice').value;
        const email = document.getElementById('alertEmail').value;
        
        try {
            const res = await fetch('/api/set-alert', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title, target_price, email })
            });
            const data = await res.json();
            
            if (res.ok) {
                showMessage('Alert set successfully!');
                bootstrap.Modal.getInstance(document.getElementById('alertModal')).hide();
            } else {
                showMessage(data.error || 'Failed to set alert', 'error');
            }
        } catch (err) {
            showMessage('Network error', 'error');
        }
    }

    function showAiSummary(title) {
        const modal = new bootstrap.Modal(document.getElementById('summaryModal'));
        const content = document.getElementById('aiSummaryContent');
        content.innerHTML = '<div class="spinner-border text-info" role="status"></div> Generating summary...';
        modal.show();
        
        fetch('/api/ai-summary', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title })
        })
        .then(res => res.json())
        .then(data => {
            content.innerHTML = `<p class="lead text-dark">${data.summary}</p><small class="text-muted">Generated by AI based on aggregated reviews.</small>`;
        });
    }

    function filterSource(source) {
        const buttons = document.querySelectorAll('.gap-2 button');
        buttons.forEach(btn => btn.classList.remove('active', 'btn-dark'));
        buttons.forEach(btn => {
            if (btn.textContent.toLowerCase().includes(source === 'all' ? 'all' : source)) {
                btn.classList.add('active', 'btn-dark');
                btn.classList.remove('btn-outline-secondary');
            } else {
                btn.classList.add('btn-outline-secondary');
            }
        });

        if (source === 'all') {
            displayProducts(allProducts);
        } else {
            const filtered = allProducts.filter(p => p.source.toLowerCase() === source);
            displayProducts(filtered);
        }
    }

    // Local filter (instant while typing)
    function filterLocal() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(query) || 
            p.source.toLowerCase().includes(query)
        );
        displayProducts(filtered);
    }

    // Online search (hits backend API)
    async function performOnlineSearch() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;

        const grid = document.getElementById('productsGrid');
        
        // Show loading state
        grid.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Searching everywhere...</h4>
                <p class="text-muted">Looking for "${query}" across multiple stores</p>
            </div>
        `;

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (response.ok && data.products) {
                // Update allProducts so addToCart can find these new items
                allProducts = data.products;
                
                // Show results
                displayProducts(data.products);
                
                if (data.products.length === 0) {
                    showMessage('No products found matching your search', 'info');
                } else {
                    showMessage(`Found ${data.total} products matching "${query}"`);
                }
            } else {
                showMessage(data.error || 'Search failed', 'error');
                // Fallback to local filter if online fails
                filterLocal();
            }
        } catch (error) {
            console.error('Search error:', error);
            showMessage('Network error during search. Showing local results.', 'error');
            filterLocal();
        }
    }

    // Add enter key support for search
    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') performOnlineSearch();
    });

    async function addToCart(productId) {
        try {
            // Find product details
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showMessage('Product details not found', 'error');
                return;
            }

            const response = await fetch('/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: product.id,
                    title: product.name || product.title || 'Unknown',
                    price: product.price,
                    quantity: 1 
                }),
                credentials: 'include'
            });

            if (response.ok) {
                showMessage('Added to cart successfully!');
                
                // Animate cart icon in navbar
                const cartIcon = document.querySelector('.fa-shopping-cart');
                cartIcon.classList.add('animate-float');
                setTimeout(() => cartIcon.classList.remove('animate-float'), 1000);
            } else {
                showMessage('Please login to add items', 'error');
                setTimeout(() => window.location.href = '/login', 1500);
            }
        } catch (error) {
            showMessage('Error adding to cart', 'error');
        }
    }
</script>
{% endblock %}
