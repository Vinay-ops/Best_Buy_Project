{% extends "base.html" %}

{% block title %}Products - Best Buy Finder{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header & Search -->
    <div class="row mb-5 align-items-center animate-fade-in">
        <div class="col-lg-6">
            <h1 class="fw-bold mb-0">Discover Products</h1>
            <p class="text-muted mt-2">Find the best deals from top retailers</p>
        </div>
        <div class="col-lg-6">
            <div class="input-group shadow-sm rounded-pill overflow-hidden">
                <input type="text" id="searchInput" class="form-control border-0 py-3 ps-4" placeholder="Search products..." oninput="filterLocal()">
                <button class="btn btn-primary px-4" type="button" onclick="performOnlineSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="d-flex gap-2 mb-4 overflow-auto pb-2 animate-fade-in delay-100">
        <button class="btn btn-dark rounded-pill px-4 active" onclick="filterSource('all')">All</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('bestbuy')">Best Buy</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('amazon')">Amazon</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterSource('walmart')">Walmart</button>
    </div>

    <!-- Products Grid -->
    <div id="loadingDiv" class="text-center py-5">
        <div class="spinner-custom mx-auto mb-3"></div>
        <p class="text-muted">Loading amazing deals...</p>
    </div>

    <div id="productsGrid" class="row g-4">
        <!-- Products will be injected here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allProducts = [];

    document.addEventListener('DOMContentLoaded', loadProducts);

    async function loadProducts() {
        const loadingDiv = document.getElementById('loadingDiv');
        const productsGrid = document.getElementById('productsGrid');

        try {
            const response = await fetch('/api/products', { credentials: 'include' });
            const data = await response.json();
            
            if (response.ok && data.products) {
                allProducts = data.products;
                loadingDiv.style.display = 'none';
                displayProducts(allProducts);
            } else {
                loadingDiv.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>Failed to load products</div>';
                showMessage('Failed to load products', 'error');
            }
        } catch (error) {
            loadingDiv.innerHTML = '<div class="text-danger"><i class="fas fa-wifi me-2"></i>Network error</div>';
            showMessage('Network error: ' + error.message, 'error');
        }
    }

    function displayProducts(products) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = '';

        if (!products || products.length === 0) {
            grid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h3>No products found</h3>
                    <p class="text-muted">Try adjusting your search or filters</p>
                </div>
            `;
            return;
        }

        products.forEach((product, index) => {
            const delayClass = index < 6 ? `delay-${(index + 1) * 100}` : '';
            const card = document.createElement('div');
            card.className = `col-sm-6 col-lg-4 col-xl-3 animate-slide-in-up ${delayClass}`;
            
            // Handle missing data gracefully
            const imgUrl = product.image || 'https://placehold.co/300x300?text=No+Image';
            const name = product.name || product.title || 'Unknown Product';
            const price = product.price !== undefined ? product.price : 'N/A';
            const source = product.source || 'Unknown';
            const productId = product.id || index; // Fallback ID
            const safeId = String(productId).replace(/'/g, "\\'");

            card.innerHTML = `
                <div class="product-card h-100 d-flex flex-column">
                    <div class="product-img-wrapper position-relative">
                        <span class="badge bg-dark position-absolute top-0 start-0 m-3 text-uppercase">${source}</span>
                        <img src="${imgUrl}" class="product-img" alt="${name}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/300x300?text=Image+Not+Found';">
                    </div>
                    <div class="card-body d-flex flex-column flex-grow-1">
                        <h5 class="card-title" title="${name}">${name}</h5>
                        <div class="mt-auto pt-3 d-flex justify-content-between align-items-center">
                            <span class="price-tag">â‚¹${price}</span>
                            <button onclick="addToCart('${safeId}')" class="btn btn-outline-primary rounded-circle p-2" title="Add to Cart">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function filterSource(source) {
        const buttons = document.querySelectorAll('.gap-2 button');
        buttons.forEach(btn => btn.classList.remove('active', 'btn-dark'));
        buttons.forEach(btn => {
            if (btn.textContent.toLowerCase().includes(source === 'all' ? 'all' : source)) {
                btn.classList.add('active', 'btn-dark');
                btn.classList.remove('btn-outline-secondary');
            } else {
                btn.classList.add('btn-outline-secondary');
            }
        });

        if (source === 'all') {
            displayProducts(allProducts);
        } else {
            const filtered = allProducts.filter(p => p.source.toLowerCase() === source);
            displayProducts(filtered);
        }
    }

    // Local filter (instant while typing)
    function filterLocal() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(query) || 
            p.source.toLowerCase().includes(query)
        );
        displayProducts(filtered);
    }

    // Online search (hits backend API)
    async function performOnlineSearch() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;

        const grid = document.getElementById('productsGrid');
        
        // Show loading state
        grid.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Searching everywhere...</h4>
                <p class="text-muted">Looking for "${query}" across multiple stores</p>
            </div>
        `;

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (response.ok && data.products) {
                // Update allProducts so addToCart can find these new items
                allProducts = data.products;
                
                // Show results
                displayProducts(data.products);
                
                if (data.products.length === 0) {
                    showMessage('No products found matching your search', 'info');
                } else {
                    showMessage(`Found ${data.total} products matching "${query}"`);
                }
            } else {
                showMessage(data.error || 'Search failed', 'error');
                // Fallback to local filter if online fails
                filterLocal();
            }
        } catch (error) {
            console.error('Search error:', error);
            showMessage('Network error during search. Showing local results.', 'error');
            filterLocal();
        }
    }

    // Add enter key support for search
    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') performOnlineSearch();
    });

    async function addToCart(productId) {
        try {
            // Find product details
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showMessage('Product details not found', 'error');
                return;
            }

            const response = await fetch('/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: product.id,
                    title: product.name || product.title || 'Unknown',
                    price: product.price,
                    quantity: 1 
                }),
                credentials: 'include'
            });

            if (response.ok) {
                showMessage('Added to cart successfully!');
                
                // Animate cart icon in navbar
                const cartIcon = document.querySelector('.fa-shopping-cart');
                cartIcon.classList.add('animate-float');
                setTimeout(() => cartIcon.classList.remove('animate-float'), 1000);
            } else {
                showMessage('Please login to add items', 'error');
                setTimeout(() => window.location.href = '/login', 1500);
            }
        } catch (error) {
            showMessage('Error adding to cart', 'error');
        }
    }
</script>
{% endblock %}
